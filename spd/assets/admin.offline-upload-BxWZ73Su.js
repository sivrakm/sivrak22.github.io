import{ad as X,ae as Z,r as w,af as ee,ag as te,J as se,K as ne,L as ie,j as e,N as re,O as ae,Q as oe,h as d,U as le,ah as ce,f as de,b as ue,B as f,a7 as $,S as E,m as pe,I as he,C as me,p as J,q as U,s as xe,t as fe,v as ge,w as be,x as je,D as ye,ai as ve,F as Se,H as Ce}from"./index-CBou6moi.js";import{H as we}from"./Header-CUbDajRy.js";import{P as De}from"./Page-BIJxk8nd.js";import{C as Q}from"./CloudUpload-ticYINSt.js";import{B as A}from"./Button-BflV7euM.js";import{A as Te}from"./Alert-C3UFCVX0.js";import{C as ze}from"./CardContent-_zFc-Dpr.js";import{C as g}from"./Chip-BXUFp7Xu.js";import{C as _}from"./CheckCircle-DhJyyHVD.js";import{D as Ie}from"./Divider-8YTaR6cQ.js";import{P as ke}from"./Person-Ppu-bxkp.js";import{P as Me}from"./Phone-CMIUrlWo.js";import{S as Re}from"./ShoppingBag-uEta9rz-.js";import{D as q}from"./Delete-DRnHzxX1.js";import{T as Ae,a as Ne,b as Oe,c as K,d as p,e as We}from"./TableRow-du5aDt-d.js";import"./Grid-IWINzjQb.js";import"./isMuiElement-fD2fXW9_.js";import"./dividerClasses-aUSE17Cl.js";function Ee(s,c,n,a,h){const[r,m]=w.useState(()=>h&&n?n(s).matches:a?a(s).matches:c);return te(()=>{if(!n)return;const l=n(s),b=()=>{m(l.matches)};return b(),l.addEventListener("change",b),()=>{l.removeEventListener("change",b)}},[s,n]),r}const Pe={...ee},Y=Pe.useSyncExternalStore;function Ue(s,c,n,a,h){const r=w.useCallback(()=>c,[c]),m=w.useMemo(()=>{if(h&&n)return()=>n(s).matches;if(a!==null){const{matches:x}=a(s);return()=>x}return r},[r,s,a,h,n]),[l,b]=w.useMemo(()=>{if(n===null)return[r,()=>()=>{}];const x=n(s);return[()=>x.matches,j=>(x.addEventListener("change",j),()=>{x.removeEventListener("change",j)})]},[r,n,s]);return Y(b,l,m)}function G(s={}){const{themeId:c}=s;return function(a,h={}){let r=X();r&&c&&(r=r[c]||r);const m=typeof window<"u"&&typeof window.matchMedia<"u",{defaultMatches:l=!1,matchMedia:b=m?window.matchMedia:null,ssrMatchMedia:I=null,noSsr:x=!1}=Z({name:"MuiUseMediaQuery",props:h,theme:r});let j=typeof a=="function"?a(r):a;return j=j.replace(/^@media( ?)/m,""),j.includes("print")&&console.warn(["MUI: You have provided a `print` query to the `useMediaQuery` hook.","Using the print media query to modify print styles can lead to unexpected results.","Consider using the `displayPrint` field in the `sx` prop instead.","More information about `displayPrint` on our docs: https://mui.com/system/display/#display-in-print."].join(`
`)),(Y!==void 0?Ue:Ee)(j,l,b,I,x)}}G();function Qe(s){return se("MuiAlertTitle",s)}ne("MuiAlertTitle",["root"]);const Le=s=>{const{classes:c}=s;return oe({root:["root"]},Qe,c)},Be=re(d,{name:"MuiAlertTitle",slot:"Root"})(le(({theme:s})=>({fontWeight:s.typography.fontWeightMedium,marginTop:-2}))),Fe=w.forwardRef(function(c,n){const a=ie({props:c,name:"MuiAlertTitle"}),{className:h,...r}=a,m=a,l=Le(m);return e.jsx(Be,{gutterBottom:!0,component:"div",ownerState:m,ref:n,className:ae(l.root,h),...r})}),He=G({themeId:ce}),V=de(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-2h2zm0-4h-2V7h2z"}));function lt(){const[s,c]=w.useState(!1),[n,a]=w.useState([]),[h,r]=w.useState(!1),m=ue(),l=He(m.breakpoints.down("sm")),b=t=>!t.items||!Array.isArray(t.items)?"Missing or invalid items array":typeof t.total!="number"?"Missing or invalid total price":!t.shippingDetails||!t.shippingDetails.phoneNumber?"Missing shipping details or phone number":null,I=async t=>{if(!t)return!1;const i=ye(J(U,"orders"),Se("offlineId","==",t),ve(1));return!(await Ce(i)).empty},x=async t=>{const i=t.target.files;if(!i||i.length===0)return;const u=[];for(let o=0;o<i.length;o++){const D=i[o];try{const O=await D.text(),y=JSON.parse(O),C=b(y);let T=C?"invalid":"valid",k=C||void 0;T==="valid"&&y.offlineId&&await I(y.offlineId)&&(T="duplicate",k="This order has already been synced."),u.push({fileName:D.name,data:y,status:T,error:k})}catch{u.push({fileName:D.name,data:null,status:"invalid",error:"Failed to parse JSON"})}}a(o=>[...o,...u]),r(!0),t.target.value=""},j=async()=>{c(!0);const t=J(U,"orders"),i=[...n];for(let u=0;u<i.length;u++){const o=i[u];if(o.status==="valid")try{if(o.data.offlineId&&await I(o.data.offlineId)){i[u]={...o,status:"duplicate",error:"Already synced."};continue}const{id:D,...O}=o.data;await xe(t,{...O,timestamp:fe(),offlineTimestamp:o.data.timestamp||new Date().toISOString(),isOfflineUpload:!0});try{const y=o.data.items||[];for(const C of y){const T=ge(U,"products",String(C.id)),k=await be(T);if(k.exists()){const W=k.data(),M={};if(C.selectedSize){const v=W.sizes||[],z=v.findIndex(S=>S.label===C.selectedSize.label);if(z!==-1){let S=C.quantity;const R={...v[z]},F=R.returnStock||0,H=Math.min(F,S);R.returnStock=F-H,S-=H,S>0&&(R.stock=(R.stock||0)-S),v[z]=R,M.sizes=v}}else{let v=C.quantity;const z=W.returnStock||0,S=Math.min(z,v);M.returnStock=z-S,v-=S,v>0&&(M.stock=(W.stock||0)-v)}Object.keys(M).length>0&&await je(T,M)}}}catch(y){console.error("Error updating stock for offline sync:",y)}i[u]={...o,status:"success"}}catch(D){i[u]={...o,status:"error",error:D.message}}}a(i),c(!1)},P=t=>{a(i=>i.filter((u,o)=>o!==t)),n.length<=1&&r(!1)},L=()=>{a([]),r(!1)},N=n.filter(t=>t.status==="valid").length,B=n.filter(t=>t.status==="success").length;return e.jsxs(f,{sx:{bgcolor:"background.default",minHeight:"100vh",pb:5},children:[e.jsx(we,{title:"Offline Order Sync"}),e.jsx(De,{children:e.jsxs(f,{sx:{p:2},children:[e.jsx(d,{variant:"h5",sx:{mb:1,fontWeight:"bold"},children:"Sync Offline Orders"}),e.jsx(d,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Upload the .json files generated while placing orders in offline mode."}),h?e.jsxs(E,{spacing:2,children:[e.jsxs(Te,{severity:"info",variant:"outlined",sx:{borderRadius:2},children:[e.jsxs(Fe,{sx:{fontWeight:"bold"},children:[n.length," Order(s) Loaded"]}),N>0?`${N} valid orders ready for sync.`:"No valid orders found in the selected files.",B>0&&` | ${B} successfully uploaded!`]}),l?e.jsx(E,{spacing:2,children:n.map((t,i)=>e.jsx(pe,{sx:{borderRadius:3,border:1,borderColor:"divider",boxShadow:"none"},children:e.jsxs(ze,{sx:{p:2,"&:last-child":{pb:2}},children:[e.jsxs(f,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:1.5},children:[e.jsxs(f,{children:[e.jsx(d,{variant:"caption",color:"text.secondary",sx:{textTransform:"uppercase",letterSpacing:1},children:t.fileName}),e.jsxs(d,{variant:"h6",sx:{fontWeight:"bold"},children:["₹",t.data?.total||0]})]}),e.jsxs(f,{children:[t.status==="valid"&&e.jsx(g,{label:"Ready",color:"info",size:"small"}),t.status==="invalid"&&e.jsx(g,{label:"Invalid",color:"error",size:"small"}),t.status==="duplicate"&&e.jsx(g,{label:"Duplicate",color:"warning",size:"small",title:t.error}),t.status==="success"&&e.jsx(g,{label:"Sync OK",color:"success",size:"small",icon:e.jsx(_,{sx:{fontSize:"1rem !important"}})}),t.status==="error"&&e.jsx(g,{label:"Failed",color:"error",size:"small",icon:e.jsx(V,{sx:{fontSize:"1rem !important"}})})]})]}),e.jsx(Ie,{sx:{mb:1.5}}),e.jsxs(E,{spacing:1,children:[e.jsxs(f,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ke,{sx:{fontSize:16,color:"text.secondary"}}),e.jsx(d,{variant:"body2",children:t.data?.shippingDetails?.firstName||"N/A"})]}),e.jsxs(f,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Me,{sx:{fontSize:16,color:"text.secondary"}}),e.jsx(d,{variant:"body2",children:t.data?.shippingDetails?.phoneNumber||"N/A"})]}),e.jsxs(f,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Re,{sx:{fontSize:16,color:"text.secondary"}}),e.jsxs(d,{variant:"body2",children:[t.data?.items?.length||0," Items"]})]})]}),(t.status==="invalid"||t.status==="error")&&e.jsxs(d,{variant:"caption",color:"error",sx:{mt:1,display:"block"},children:["Error: ",t.error]}),t.status!=="success"&&t.status!=="error"&&e.jsx(f,{sx:{mt:2,display:"flex",justifyContent:"flex-end"},children:e.jsx(A,{size:"small",color:"error",startIcon:e.jsx(q,{}),onClick:()=>P(i),disabled:s,children:"Remove"})})]})},i))}):e.jsx(Ae,{component:$,sx:{borderRadius:3,border:1,borderColor:"divider",boxShadow:"none"},children:e.jsxs(Ne,{children:[e.jsx(Oe,{sx:{bgcolor:"action.hover"},children:e.jsxs(K,{children:[e.jsx(p,{sx:{fontWeight:"bold"},children:"File / ID"}),e.jsx(p,{sx:{fontWeight:"bold"},children:"Customer"}),e.jsx(p,{sx:{fontWeight:"bold"},children:"Items"}),e.jsx(p,{sx:{fontWeight:"bold"},children:"Total"}),e.jsx(p,{sx:{fontWeight:"bold"},children:"Status"}),e.jsx(p,{sx:{fontWeight:"bold"},align:"right",children:"Action"})]})}),e.jsx(We,{children:n.map((t,i)=>e.jsxs(K,{children:[e.jsxs(p,{children:[e.jsx(d,{variant:"body2",sx:{fontWeight:500},children:t.fileName}),e.jsx(d,{variant:"caption",color:"text.secondary",children:t.data?.timestamp?new Date(t.data.timestamp).toLocaleString():"N/A"})]}),e.jsxs(p,{children:[t.data?.shippingDetails?.firstName||"N/A",e.jsx(d,{variant:"caption",display:"block",color:"text.secondary",children:t.data?.shippingDetails?.phoneNumber})]}),e.jsx(p,{children:t.data?.items?.length||0}),e.jsxs(p,{sx:{fontWeight:"bold"},children:["₹",t.data?.total?.toLocaleString()||0]}),e.jsxs(p,{children:[t.status==="valid"&&e.jsx(g,{label:"Ready",color:"info",variant:"outlined",size:"small"}),t.status==="invalid"&&e.jsx(g,{label:"Invalid",color:"error",variant:"outlined",size:"small",title:t.error}),t.status==="duplicate"&&e.jsx(g,{label:"Duplicate",color:"warning",variant:"outlined",size:"small",title:t.error}),t.status==="success"&&e.jsx(g,{label:"Synced",color:"success",size:"small",icon:e.jsx(_,{})}),t.status==="error"&&e.jsx(g,{label:"Failed",color:"error",size:"small",icon:e.jsx(V,{}),title:t.error})]}),e.jsx(p,{align:"right",children:t.status!=="success"&&e.jsx(he,{color:"error",size:"small",onClick:()=>P(i),disabled:s,children:e.jsx(q,{})})})]},i))})]})}),e.jsxs(E,{direction:l?"column":"row",spacing:2,justifyContent:"space-between",sx:{mt:2},children:[e.jsx(A,{variant:"outlined",color:"inherit",onClick:L,disabled:s,fullWidth:l,sx:{borderRadius:10,textTransform:"none"},children:"Cancel & Clear"}),e.jsxs(f,{sx:{display:"flex",gap:2},children:[e.jsxs(A,{variant:"outlined",component:"label",disabled:s,fullWidth:l,sx:{borderRadius:10,textTransform:"none"},children:["Add More Files",e.jsx("input",{type:"file",hidden:!0,multiple:!0,accept:".json",onChange:x})]}),e.jsx(A,{variant:"contained",color:"primary",onClick:j,disabled:s||N===0,fullWidth:l,startIcon:s?e.jsx(me,{size:20,color:"inherit"}):e.jsx(Q,{}),sx:{borderRadius:10,px:4,textTransform:"none",fontWeight:"bold"},children:s?"Syncing...":`Sync ${N} Orders`})]})]})]}):e.jsxs($,{sx:{p:6,textAlign:"center",border:"2px dashed",borderColor:"primary.main",borderRadius:4,bgcolor:"rgba(25, 118, 210, 0.02)",transition:"all 0.3s","&:hover":{bgcolor:"rgba(25, 118, 210, 0.05)",borderColor:"primary.dark"}},children:[e.jsx(Q,{sx:{fontSize:80,color:"primary.main",mb:2,opacity:.8}}),e.jsx(d,{variant:"h6",sx:{mb:1,fontWeight:"bold"},children:"Ready to upload"}),e.jsx(d,{variant:"body2",sx:{mb:4,color:"text.secondary",maxWidth:300,mx:"auto"},children:"Drag and drop your order files here or click the button below to browse."}),e.jsxs(A,{variant:"contained",component:"label",size:"large",startIcon:e.jsx(Q,{}),sx:{borderRadius:10,px:4,py:1.5,textTransform:"none",fontSize:"1rem",fontWeight:"bold"},children:["Browse Files",e.jsx("input",{type:"file",hidden:!0,multiple:!0,accept:".json",onChange:x})]})]})]})})]})}export{lt as component};
